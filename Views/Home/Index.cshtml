@using System.Text.Json
@model Projekt2.ViewModels.HomeViewModel
@{
    ViewData["Title"] = "Home Page";
    var currentYear = DateTime.Now.Year.ToString();
}
<div class="text-center">
    <h1 class="display-4">Welcome</h1>
    <!-- <p>Learn about <a href="https://learn.microsoft.com/aspnet/core">building Web apps with ASP.NET Core</a>.</p> -->
</div>
<dl>
    <dd>
        <h2><strong>Ilość opakowań aktualnie w magazynie</strong></h2>
    </dd>
    <dt>
        <h3>@Model.Ilosc_Magazyn?.ToString("N0")</h3>
    </dt>
    <hr />

    <dd>
        <h2><strong>Ilość kg cukru aktualnie w silosie</strong></h2>
    </dd>
    <dt>
        <h3>@Model.Ilosc_Silos?.ToString("N0")</h3>
    </dt>
    <hr />
    <dd>
        <h2><strong>Ilość kg buraków aktualnie na placu</strong></h2>
    </dd>
    <dt>
        @{
            @if (Model.Ilosc_Plac_Now != 0)
            {
                <h3>
                    @(Model.Ilosc_Plac_Now?.ToString("N0"))
                </h3>
            }
            else
            {
                <h3>
                    W tym roku nie było jeszcze żadnych dostaw.
                </h3>
            }
        }
    </dt>
    <hr />
    <dd>
        <h2><strong>Ilość buraków w poprzednich latach</strong></h2>
    </dd>
    <dt>
        <canvas id="chart1" width="800" height="400"></canvas>

        <table class="table">
            <thead>
                <tr>
                    <th>Rok</th>
                    <th>Ilosc dostarczonych buraków [kg]</th>
                    <th>Ilosc niewykorzystanych buraków [kg]</th>
                    <th>Ilosc wykorzystanych buraków [kg]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Ilosc_Plac)
                {
                    if (Model.Ilosc_niewykorzystane_Plac.ContainsKey(item.Key))
                    {
                        var niewykorzysane = Model.Ilosc_niewykorzystane_Plac[item.Key];
                        <tr>
                            <td>@item.Key</td>
                            <td>@item.Value.ToString("N0")</td>
                            <td>@niewykorzysane.ToString("N0")</td>
                            <td>@((item.Value - niewykorzysane).ToString("N0"))</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </dt>
</dl>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
    const dostarczone = @Html.Raw(JsonSerializer.Serialize(Model.Ilosc_Plac));
    const niewykorzystane = @Html.Raw(JsonSerializer.Serialize(Model.Ilosc_niewykorzystane_Plac));

    const labels = Object.keys(dostarczone);
    const wykorzystane = labels.map(year => {
        const dost = dostarczone[year] || 0;
        const niewyk = niewykorzystane[year] || 0;
        return dost - niewyk;
    });

    const chart1 = new Chart(document.getElementById('chart1').getContext('2d'), {
        data: 
        {
            labels: labels,
            datasets: 
            [
                {
                    type: 'bar',
                    label: 'Ilość dostarczonych buraków',
                    data: labels.map(year => dostarczone[year]),
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    stack: 'stack1'
                }, 
                {
                    type: 'bar',
                    label: 'Ilość niewykorzystanych buraków',
                    data: labels.map(year => niewykorzystane[year]),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    stack: 'stack2'
                }, 
                {
                    type: 'bar',
                    label: 'Ilość wykorzystanych buraków',
                    data: wykorzystane,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    stack: 'stack2'
                }
            ]
        },
            options: {
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const value = context.parsed.y;
                        return context.dataset.label + ': ' + value.toLocaleString('pl-PL');
                    }
                }
            }
        },
        scales: {
            x: {
                stacked: true
            },
            y: {
                stacked: true,
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('pl-PL');
                    }
                }
            }
        }
    }
    });
</script>
